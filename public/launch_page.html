<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="utf-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0, shrink-to-fit=no">
  <title>Glitch</title>
  <meta name="googlebot" content="index, follow, snippet">
  <link rel="shortcut icon" href="favicon.ico">
  <link rel="icon" type="image/png" href="assets/favicon.png">
  <link rel="stylesheet" href="scripts/css/global.css">
  <link href="https://fonts.googleapis.com/css2?family=Material+Symbols+Outlined:wght@250" rel="stylesheet">
  <script src="uv/uv.bundle.js" defer></script>
  <script src="uv/uv.config.js" defer></script>
  <style>
    body {
      background-color: black;
      margin: 0;
      overflow: hidden;
    }

    #searchbar {
      background-color: #2c2c2c;
      width: 100%;
      display: flex;
      justify-content: center;
      align-items: center;
      height: 40px;
      position: absolute;
      top: 0;
      z-index: 15;
      box-sizing: border-box;
      padding: 0 10px;
    }

    #searchbar input {
      background-color: rgb(63, 63, 63);
      color: white;
      border: none;
      border-radius: 5px;
      padding: 5px 10px;
      width: 50%;
      box-sizing: border-box;
    }

    #searchbar input:focus {
      outline: none;
    }

    #uv-frame {
      width: 100%;
      height: calc(100vh - 40px);
      border: none;
      position: absolute;
      top: 40px;
      left: 0;
    }

    #home, #refresh {
      margin-right: 10px;
      filter: invert(1);
      cursor: pointer;
    }

    img {
      width: 20px;
      margin-left: 10px;
      cursor: pointer;
    }

    .loader {
      width: 48px;
      height: 48px;
      border: 5px solid;
      border-color: white transparent;
      border-radius: 50%;
      display: inline-block;
      box-sizing: border-box;
      animation: rotation 1s linear infinite;
    }

    @keyframes rotation {
      0% {
        transform: rotate(0deg);
      }
      100% {
        transform: rotate(360deg);
      }
    }
  </style>
  <script async src="https://www.googletagmanager.com/gtag/js?id=G-278K4F012J"></script>
  <script>
    window.dataLayer = window.dataLayer || [];
    function gtag(){dataLayer.push(arguments);}
    gtag('js', new Date());
    gtag('config', 'G-278K4F012J');
  </script>
</head>
<body>
  <div id="searchbar">
    <span id="refresh" onclick="location.reload()" class="material-symbols-outlined" style="margin-right: 25px; color: black;">refresh</span>
    <input id="search" oninput="search()" placeholder="Input a URL or search..." type="search"/>
    <span onclick="navigateToPage()" class="material-symbols-outlined" style="margin-left: 25px;">search</span>
  </div>

  <div id="frames">
    <form id="uv-form" class="flex-center">
      <input id="uv-search-engine" value="https://www.google.com/search?q=%s" type="hidden">
      <input id="uv-address" type="hidden" placeholder="Search the web freely">
    </form>
    <iframe id="uv-frame" style="border: none;">
    
      <div style="padding: 20x; border-radius: 15px; background-color: #1f1f1f; width: 25%; padding-top: 25px; padding-bottom: 25px;">
        <script type="text/javascript">
          atOptions = {
            'key' : 'e17a0ee6656019085028f3a33b2a5424',
            'format' : 'iframe',
            'height' : 250,
            'width' : 300,
            'params' : {}
          };
        </script>
        <script type="text/javascript" src="//www.topcreativeformat.com/e17a0ee6656019085028f3a33b2a5424/invoke.js"></script>
        <p><b style="color: rgb(124, 124, 124);">AD to pay for servers.</b></p>
      </div>
      </center>
    
    
    </iframe>
  </div>

  <script>
    let typing = 0;

    document.getElementById("search").addEventListener("focusin", () => typing = 1);
    document.getElementById("search").addEventListener("focusout", () => typing = 0);

    function getURLParameter(name) {
      const regex = new RegExp(`[\\?&]${name}=([^&#]*)`);
      const results = regex.exec(location.search);
      return results ? decodeURIComponent(results[1].replace(/\+/g, ' ')) : '';
    }

    function navigateToPage() {
      const url = document.getElementById('search').value;
      window.location = `launch_page.html?${url}`;
    }

    function updateDocumentTitle() {
      const frame = document.getElementById("uv-frame");
      const frameTitle = frame.contentDocument.title;
      if (document.title !== frameTitle) {
        document.title = frameTitle;
      }
    }

    document.getElementById("uv-frame").onload = () => {
      setInterval(updateDocumentTitle, 500);
    };

    setTimeout(() => {
      setInterval(() => {
        if (!typing) {
          try {
            const frame = document.getElementById("uv-frame");
            const decodedUrl = Ultraviolet.codec.xor.decode(frame.contentWindow.location.href.split("/uv/service/")[1]);
            if (decodedUrl && decodedUrl !== document.getElementById("search").value) {
              document.getElementById("search").value = decodedUrl;
            }
          } catch (e) {
            console.log(e);
          }
        }
      }, 500);
    }, 1000);

    async function fetchGlitchDomains() {
      try {
        const response = await fetch("https://raw.githubusercontent.com/Glitch-Network/glitch_net_domains/main/db.txt");
        const data = await response.text();
        return data.split("\n");
      } catch (error) {
        console.log("Glitch domains unavailable.");
        return [];
      }
    }

    async function search(input) {
      const domains = await fetchGlitchDomains();
      const searchEngine = document.getElementById("uv-search-engine").value;
      let url = buildSearchUrl(input, searchEngine, domains);

      try {
        new URL(url); // Validate URL
      } catch (err) {
        url = `${searchEngine}${encodeURIComponent(input)}`;
      }

      return url;
    }

    function buildSearchUrl(input, searchEngine, domains) {
      let url;
      try {
        url = new URL(input).toString();
      } catch (err) {
        url = `${searchEngine}${encodeURIComponent(input)}`;
      }

      if (url.startsWith("http://")) {
        url = url.replace("http://", "https://");
      } else if (!url.startsWith("https://")) {
        url = `https://${url}`;
      }

      if (url.includes("reddit.com")) {
        url = url.replace("reddit.com", "l.opnxng.com");
      }

      for (const domain of domains) {
        if (domain.includes(url)) {
          url = domain.split("|")[1];
          break;
        }
      }

      const proxyBridge = localStorage.getItem("proxy");
      const premiumStatus = localStorage.getItem("premium") === "true";

      if (premiumStatus && proxyBridge) {
        url = `${getProxyBridge(proxyBridge)}${encodeURIComponent(url)}`;
      }

      return url;
    }

    function getProxyBridge(proxyBridge) {
      switch (proxyBridge) {
        case "Glitch EU Proxy":
          return "https://v6-out.onrender.com/llaunch.html?url=";
        case "12FT":
          return "https://12ft.io/";
        case "Archive.org/Wayback Machine":
          return "https://web.archive.org/";
        case "Google Cache":
          return "https://webcache.googleusercontent.com/search?q=cache:";
        default:
          return "";
      }
    }

    document.addEventListener("DOMContentLoaded", async () => {
      const address = document.getElementById("uv-address");
      address.value = getURLParameter("url");

      try {
        await registerSW();
      } catch (err) {
        console.warn("Failed to register service worker:", err);
      }

      const url = await search(address.value);
      const frame = document.getElementById("uv-frame");
      frame.src = `${__uv$config.prefix}${__uv$config.encodeUrl(url)}`;
      frame.style.display = "block";
    });

    async function registerSW() {
      if (!('serviceWorker' in navigator)) {
        throw new Error("Your browser doesn't support service workers.");
      }

      if (location.protocol !== "https:" && !["localhost", "127.0.0.1"].includes(location.hostname)) {
        throw new Error("Service workers cannot be registered without https.");
      }

      try {
        await navigator.serviceWorker.register("sw.js", {
          scope: __uv$config.prefix,
        });
      } catch (error) {
        console.error("Service Worker registration failed:", error);
      }
    }
  </script>
</body>
</html>
